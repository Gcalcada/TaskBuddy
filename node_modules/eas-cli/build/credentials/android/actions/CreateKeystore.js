"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CreateKeystore = void 0;
const tslib_1 = require("tslib");
const log_1 = tslib_1.__importDefault(require("../../../log"));
const projectUtils_1 = require("../../../project/projectUtils");
const promptForCredentials_1 = require("../../utils/promptForCredentials");
const credentials_1 = require("../credentials");
const keystore_1 = require("../utils/keystore");
const keystoreNew_1 = require("../utils/keystoreNew");
class CreateKeystore {
    constructor(account) {
        this.account = account;
    }
    async runAsync(ctx) {
        if (ctx.nonInteractive) {
            throw new Error(`New keystore cannot be created in non-interactive mode.`);
        }
        const projectId = await (0, projectUtils_1.getProjectIdAsync)(ctx.exp);
        const keystore = await this.provideOrGenerateAsync(projectId);
        const keystoreFragment = await ctx.android.createKeystoreAsync(this.account, keystore);
        log_1.default.succeed('Created keystore');
        return keystoreFragment;
    }
    async provideOrGenerateAsync(projectId) {
        const providedKeystore = await (0, promptForCredentials_1.askForUserProvidedAsync)(credentials_1.keystoreSchema);
        if (providedKeystore) {
            const providedKeystoreWithType = (0, keystoreNew_1.getKeystoreWithType)(providedKeystore);
            (0, keystoreNew_1.validateKeystore)(providedKeystoreWithType);
            return providedKeystoreWithType;
        }
        return await (0, keystore_1.generateRandomKeystoreAsync)(projectId);
    }
}
exports.CreateKeystore = CreateKeystore;
